<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <link href="/main.css" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}">
</head>
<body th:attr="data-username=${username}">
<div class="container">
    <div th:replace="~{ nav.html::navbar }"></div>
    <h4 class="ml-2 my-3 text-center">채팅 페이지</h4>
    <div id="participantsList">참여자: 0명</div>
    <div id="participantsNames">참여자: </div>
    <div id="messageArea" class="alert alert-secondary"></div>
    <input type="text" id="messageInput" class="form-control" placeholder="메시지 입력...">
    <button onclick="sendMessage()" class="btn btn-primary">전송</button>
</div>

<script>
    var roomId = [[${roomId}]];
    var stompClient = null;
    var username = document.body.getAttribute('data-username');
    console.log("유저네임: " + username); // 확인용으로 username이 잘 가져와지는지 콘솔에 출력해보세요.


    window.onload = function() {
        connect();
    };

    function connect() {
        var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        var socket = new SockJS('/websocket-chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({'X-CSRF-TOKEN': csrfToken}, function (frame) {
            console.log('Connected: ' + frame);
            // 새로운 메시지와 참여자 정보를 구독
            stompClient.subscribe('/topic/' + roomId, function (message) {
                var msg = JSON.parse(message.body);
                showMessage(msg);
            });
            stompClient.subscribe('/topic/participants/' + roomId, function (message) {
                var info = JSON.parse(message.body);
                updateParticipants(info);
                // 새로운 참여자 정보를 받으면 콘솔에 출력
                console.log("현재 참여자: " + info.count + "명 - " + Array.from(info.names).join(', '));
            });
            sendJoinMessage(); // 채팅방에 접속한 사용자 정보를 서버로 전송
        });
    }

    function sendMessage() {
        var messageContent = document.getElementById('messageInput').value.trim();
        if (messageContent) {
            stompClient.send("/app/chat.sendMessage/" + roomId, {}, JSON.stringify({content: messageContent, type: 'CHAT'}));
            document.getElementById('messageInput').value = '';
        }
    }

    function sendJoinMessage() {
        var joinMsg = {sender: "System", content: username + "님이 접속하였습니다.", type: 'JOIN'};
        stompClient.send("/app/chat.addUser/" + roomId, {}, JSON.stringify(joinMsg));
    }

    function showMessage(message) {
        console.log("Received message:", message);
        var messageArea = document.getElementById('messageArea');
        var messageElement = document.createElement('div');
        messageElement.classList.add('chat-message');

        // 메시지 유형에 따라 처리, 메시지 객체에서 type 속성을 올바르게 읽어와야 함
        if (message.type === 'JOIN' || message.type === 'LEAVE') {
            // 시스템 메시지 처리
            messageElement.textContent = message.content;
        } else if (message.type === 'CHAT') {
            // 일반 채팅 메시지 처리
            messageElement.textContent = message.sender + ": " + message.content;
        } else {
            // 기타 메시지 유형
            messageElement.textContent = "Unknown message type";
        }

        messageArea.appendChild(messageElement);
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    function updateParticipants(data) {
        var count = data.count;
        var names = data.names ? Array.from(data.names).join(', ') : '';
        document.getElementById('participantsList').textContent = `참여자: ${count}명`;
        document.getElementById('participantsNames').textContent = `참여자: ${names}`;
        console.log("현재 참여자: " + count + "명 - " + names);
    }

    stompClient.subscribe('/topic/participants/' + roomId, function (message) {
    var info = JSON.parse(message.body);
    updateParticipants(info);
    console.log("현재 참여자: " + info.count + "명 - " + Array.from(info.names).join(', '));
});

    window.addEventListener("beforeunload", function (event) {
    navigator.sendBeacon("/app/disconnect", JSON.stringify({roomId: roomId, username: username}));
});


</script>

</body>
</html>
