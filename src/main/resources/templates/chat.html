<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <link href="/main.css" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}">
</head>
<body>
<div class="container">
    <div th:replace="~{ nav.html::navbar }"></div>
    <h4 class="ml-2 my-3 text-center">채팅 페이지</h4>
    <div id="messageArea" class="alert alert-secondary"></div>
    <input type="text" id="messageInput" class="form-control" placeholder="메시지 입력...">
    <button onclick="sendMessage()" class="btn btn-primary">전송</button>
</div>

<script th:inline="javascript">
    var roomId = [[${roomId}]];
    var stompClient = null;

    window.onload = function() {
        connect();
        loadMessages(roomId);  // 페이지 로드 시 저장된 메시지를 로드하여 표시
    };

    function getCsrfToken() {
        return document.querySelector('meta[name="_csrf"]').getAttribute('content');
    }

    function connect() {
    var csrfToken = getCsrfToken();
    var socket = new SockJS('/websocket-chat');
    stompClient = Stomp.over(socket);
    stompClient.connect({'X-CSRF-TOKEN': csrfToken}, function (frame) {
        console.log('Connected: ' + frame);
        stompClient.subscribe('/topic/' + roomId, function (message) {
            var msg = JSON.parse(message.body);
            showMessage(msg);
            saveMessage(roomId, msg); // 메시지 저장은 표시 후에 수행
        });
        // 방 입장 메시지 바로 표시
        sendJoinMessage();
    });
}

    function sendMessage() {
        var messageContent = document.getElementById('messageInput').value.trim();
        if (messageContent) {
            stompClient.send("/app/chat.sendMessage/" + roomId, {}, JSON.stringify({content: messageContent, type: 'CHAT'}));
            document.getElementById('messageInput').value = '';
        }
    }

    function sendJoinMessage() {
        var joinMsg = {sender: "System", content: "채팅을 시작합니다.", type: 'JOIN'};
        showMessage(joinMsg);
        saveMessage(roomId, joinMsg);
    }

    function showMessage(message) {
        var messageArea = document.getElementById('messageArea');
        var messageElement = document.createElement('div');
        messageElement.classList.add('chat-message');
        messageElement.textContent = message.sender + ": " + message.content;
        messageArea.appendChild(messageElement);
        messageArea.scrollTop = messageArea.scrollHeight; // Scroll to the bottom
    }

    function saveMessage(roomId, message) {
        let key = 'chatMessages_' + roomId;
        let messages = localStorage.getItem(key);
        messages = messages ? JSON.parse(messages) : [];
        messages.push(message);
        localStorage.setItem(key, JSON.stringify(messages));
    }

    function loadMessages(roomId) {
        let key = 'chatMessages_' + roomId;
        let messages = localStorage.getItem(key);
        if (messages) {
            messages = JSON.parse(messages);
            messages.forEach(message => showMessage(message));
        }
    }
</script>

</body>
</html>
